---

- name: Install chaincode dependencies
  npm:
    path: '{{ fabric_starter_workdir }}/chaincode/fabcar/javascript'

- name: Package chaincode
  #raw: "docker exec 'cli.{{ org }}.{{ global_domain }}' bash -c 'export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 && peer chaincode install -n {{ item.chaincode.name }} -v {{ item.chaincode.version }} -p {% if global_chaincode_lang != 'golang' %} /opt/gopath/src/{{ item.chaincode.name }} {% else %} {{ item.chaincode.name }} {% endif %} -l {{ global_chaincode_lang }}'"
  raw: 'export FABRIC_CFG_PATH=$PWD &&
        export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="org0MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
        peer lifecycle chaincode package fabcar.tar.gz --path {{ fabric_starter_workdir }}/chaincode/fabcar/javascript/ --lang node --label fabcar_1'
  when: "org in item.particapants"
  #ignore_errors: true

- name: Install chaincode
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="org0MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
        peer lifecycle chaincode install fabcar.tar.gz'

- name: Approve for org
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="org0MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer lifecycle chaincode queryinstalled >&log.txt &&
        peer lifecycle chaincode approveformyorg -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem --channelID {{ item.name }} --name fabcar --version 1 --init-required --package-id $(sed -n "/fabcar_1/{s/^Package ID: //; s/, Label:.*$//; p;}" log.txt) --sequence 1 >&log2.txt'

- name: Commit chaincode
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="org0MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer lifecycle chaincode commit -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem --channelID {{ item.name }} --name fabcar --version 1 --sequence 1 --init-required --peerAddresses peer0.{{ org }}.{{ global_domain }}:7051 --tlsRootCertFiles {{ peer_org }}/tls/ca.crt >&log3.txt'

- name: Invoke chaincode
  raw: "export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID='org0MSP' &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer chaincode invoke -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem -C {{ item.name }} -n fabcar --peerAddresses peer0.{{ org }}.{{ global_domain }}:7051 --tlsRootCertFiles {{ peer_org }}/tls/ca.crt --isInit -c '{\"function\":\"initLedger\",\"Args\":[]}' &&
        sleep 10"

- name: Query chaincode
  raw: "export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID='org0MSP' &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer chaincode query -C {{ item.name }} -n fabcar -c '{\"Args\":[\"queryAllCars\"]}' >&res.txt"

#  peer lifecycle chaincode commit -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com --channelID mychannel --name fabcar --version 1.0 --sequence 1 --init-required --tls true --cafile ${PWD}/organizations/ordererOrganizations/example.com/orderers/orderer.example.com/msp/tlscacerts/tlsca.example.com-cert.pem --peerAddresses localhost:7051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/tls/ca.crt --peerAddresses localhost:9051 --tlsRootCertFiles ${PWD}/organizations/peerOrganizations/org2.example.com/peers/peer0.org2.example.com/tls/ca.crt

#peer chaincode install -n {{ item.chaincode.name }} -v {{ item.chaincode.version }} -p ./chaincode/fabcar/javascript" #{% if global_chaincode_lang != 'golang' %} /opt/gopath/src/{{ item.chaincode.name }} {% else %} {{ item.chaincode.name }} {% endif %} -l {{ global_chaincode_lang }}'"
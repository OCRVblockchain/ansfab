---
- name: Transfer chaincode
  copy:
    src: "./chaincode"
    dest: "{{ fabric_starter_workdir }}"
    directory_mode: yes

- name: Install chaincode dependencies
  npm:
    path: '{{ fabric_starter_workdir }}/chaincode/fabcar/javascript'

- name: Package chaincode
  raw: 'export FABRIC_CFG_PATH=$PWD &&
        export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="{{ org }}MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
        peer lifecycle chaincode package fabcar.tar.gz --path {{ fabric_starter_workdir }}/chaincode/fabcar/javascript/ --lang node --label fabcar_1'
  when: "org in item.particapants"

- name: Install chaincode
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="{{ org }}MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
        peer lifecycle chaincode install fabcar.tar.gz'

- name: Approve for org
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="{{ org }}MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer lifecycle chaincode queryinstalled >&log.txt &&
        peer lifecycle chaincode approveformyorg -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem --channelID {{ item.name }} --name fabcar --version 1 --init-required --package-id $(sed -n "/fabcar_1/{s/^Package ID: //; s/, Label:.*$//; p;}" log.txt) --sequence 1 >&log2.txt'

#- name: Prepare conn params
#  raw: 'PARAM="--peerAddresses peer0.{{ org }}.{{ global_domain }}:7051 --tlsRootCertFiles {{ local_org_dir }}/peerOrganizations/{{ org }}.{{ global_domain }}/peers/peer0.{{ org }}.{{ global_domain }}/tls/ca.crt" &&
#        echo $PARAM >> temp'
#  delegate_to: localhost

- name: Build connection params
  shell: echo -n "--peerAddresses peer0.{{ org }}.{{ global_domain }}:7051 --tlsRootCertFiles {{ local_org_dir }}/peerOrganizations/{{ org }}.{{ global_domain }}/peers/peer0.{{ org }}.{{ global_domain }}/tls/ca.crt " >> conn_params.txt
  delegate_to: localhost

- name: Commit chaincode
  raw: 'export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID="{{ org }}MSP" &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ local_peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ local_admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer lifecycle chaincode commit -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ local_orderer_dir }}/tlsca/tlsca.{{ global_domain }}-cert.pem --channelID {{ item.name }} --name fabcar --version 1 --sequence 1 --init-required $(cat ./conn_params.txt) >&log3.txt'

  when: "org in item.particapants[0]"
  delegate_to: localhost

- name: Invoke chaincode
  raw: "export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID='{{ org }}MSP' &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ local_peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ local_admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer chaincode invoke -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 --tls --cafile {{ local_orderer_dir }}/tlsca/tlsca.{{ global_domain }}-cert.pem -C {{ item.name }} -n fabcar $(cat ./conn_params.txt) --isInit -c '{\"function\":\"initLedger\",\"Args\":[]}' &&
        sleep 10"

  when: "org in item.particapants[0]"
  delegate_to: localhost

- name: Query chaincode
  raw: "export CORE_PEER_TLS_ENABLED=true &&
        export CORE_PEER_LOCALMSPID='{{ org }}MSP' &&
        export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
        export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
        export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&

        peer chaincode query -C {{ item.name }} -n fabcar -c '{\"Args\":[\"queryAllCars\"]}' >&res.txt"

- name: Creating channels
  block:

    - name: Creating channels
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID=org0MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel create \
            -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 \
            -c {{ item.name }} \
            -f {{ fabric_artifacts }}/channel/{{ item.name }}.tx \
            --outputBlock {{ fabric_artifacts }}/channel/{{ item.name }}.block \
            --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem"
      loop: "{{ global_channels }}"
      when: "org in item.particapants[0]"

    - name: Joining other channels
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID=org0MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel join -b {{ fabric_artifacts }}/channel/{{ item.name }}.block"
      loop: "{{ global_channels }}"
      when: "org in item.particapants"

    - name: Update anchor peers
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID=org0MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel update -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 -c {{ item.name }} -f {{ fabric_artifacts }}/channel/{{ org }}MSPanchors-{{ item.name }}.tx --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem"
      loop: "{{ global_channels }}"
      when: "org in item.particapants"

#"peer channel update -o localhost:7050 --ordererTLSHostnameOverride orderer.example.com -c $CHANNEL_NAME -f ./channel-artifacts/${CORE_PEER_LOCALMSPID}anchors.tx --tls --cafile $ORDERER_CA >&log.txt"
# -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 \
- name: Creating channels
  block:

    - name: Copying core.yaml to FABRIC_CFG_PATH
      raw: "docker cp peer0.{{ org }}.{{ global_domain }}:/etc/hyperledger/fabric/core.yaml ."

    - name: Creating channels
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID={{ org }}MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel create \
            -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 \
            -c {{ item.name }} \
            -f {{ fabric_artifacts }}/channel/{{ item.name }}.tx \
            --outputBlock {{ fabric_artifacts }}/channel/{{ item.name }}.block \
            --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem"
      loop: "{{ global_channels }}"
      when: "org in item.particapants[0]"


    - name: Synchronize generated channel block files (artifacts)
      synchronize: src="{{ fabric_artifacts }}/channel/{{ item.name }}.block" dest="{{ local_artifacts }}/channel/" mode=pull recursive=yes
      loop: "{{ global_channels }}"
      when: "org in item.particapants[0]"

    - name: Synchronize generated channel block files (artifacts) back
      # become: true
      synchronize: src="{{ local_artifacts }}/channel/{{ item.name }}.block" dest="{{ fabric_artifacts }}/channel/" recursive=yes
      loop: "{{ global_channels }}"
      when: "org in item.particapants"

    - name: Joining other channels
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID={{ org }}MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel join -b {{ fabric_artifacts }}/channel/{{ item.name }}.block"
      when: "org in item.particapants"
      loop: "{{ global_channels }}"

    - name: Update anchor peers
      raw: "export CORE_PEER_TLS_ENABLED=true &&
            export CORE_PEER_LOCALMSPID={{ org }}MSP &&
            export CORE_PEER_TLS_ROOTCERT_FILE={{ peer_dir }}/tls/ca.crt &&
            export CORE_PEER_MSPCONFIGPATH={{ admin_dir }}/msp &&
            export CORE_PEER_ADDRESS=peer0.{{ org }}.{{ global_domain }}:7051 &&
            peer channel update -o orderer{{ orderer_id | default() }}.{{ global_domain }}:7050 -c {{ item.name }} -f {{ fabric_artifacts }}/channel/{{ org }}MSPanchors-{{ item.name }}.tx --tls --cafile {{ orderer_org }}/tlsca/tlsca.{{ global_domain }}-cert.pem"
      when: "org in item.particapants"
      loop: "{{ global_channels }}"
